import aws4 from 'aws4';
import dotenv from 'dotenv';
import pLimit from 'p-limit';
import fs from 'fs/promises';
import path from 'path';

dotenv.config({ path: '.env.local' });
const limit = pLimit(20);

const region = process.env.region;
const credentials = {
  accessKeyId: process.env.accessKeyId,
  secretAccessKey: process.env.secretAccessKey,
};
const OPEN_SEARCH_URL = process.env.OPEN_SEARCH_URL;

const removedZipCodes = [
  "6230",
  "6231",
  "6232",
  "6401",
  "6278",
  "6001",
  "6233",
  "6330",
  "6750",
  "6063",
  "6403",
  "6037",
  "6524",
  "6801",
  "6751",
  "6002",
  "6043",
  "6404",
  "6334",
  "6405",
  "6601",
  "6602",
  "6604",
  "6605",
  "6606",
  "6607",
  "6608",
  "6610",
  "6650",
  "6673",
  "6699",
  "6752",
  "6010",
  "6011",
  "6016",
  "6804",
  "6234",
  "6013",
  "6018",
  "6331",
  "6019",
  "6020",
  "6409",
  "6332",
  "6235",
  "6408",
  "6410",
  "6411",
  "6412",
  "6413",
  "6414",
  "6415",
  "6021",
  "6022",
  "6237",
  "6753",
  "6754",
  "6807",
  "6238",
  "6416",
  "6810",
  "6811",
  "6813",
  "6814",
  "6816",
  "6817",
  "6239",
  "6820",
  "6241",
  "6417",
  "6418",
  "6422",
  "6023",
  "6024",
  "6025",
  "6026",
  "6423",
  "6424",
  "6108",
  "6118",
  "6128",
  "6138",
  "6027",
  "6512",
  "6243",
  "6333",
  "6088",
  "6028",
  "6244",
  "6242",
  "6612",
  "6029",
  "6082",
  "6083",
  "6426",
  "6245",
  "6824",
  "6825",
  "6828",
  "6031",
  "6030",
  "6032",
  "6034",
  "6335",
  "6755",
  "6829",
  "6336",
  "6033",
  "6756",
  "6035",
  "6838",
  "6830",
  "6831",
  "6832",
  "6836",
  "6246",
  "6340",
  "6349",
  "6437",
  "6438",
  "6439",
  "6514",
  "6517",
  "6518",
  "6247",
  "6350",
  "6101",
  "6102",
  "6103",
  "6104",
  "6105",
  "6106",
  "6112",
  "6114",
  "6115",
  "6120",
  "6123",
  "6126",
  "6132",
  "6134",
  "6140",
  "6141",
  "6142",
  "6143",
  "6144",
  "6145",
  "6146",
  "6147",
  "6150",
  "6151",
  "6152",
  "6153",
  "6154",
  "6155",
  "6156",
  "6160",
  "6161",
  "6167",
  "6176",
  "6180",
  "6183",
  "6199",
  "6791",
  "6440",
  "6248",
  "6441",
  "6442",
  "6351",
  "6757",
  "6419",
  "6758",
  "6039",
  "6249",
  "6339",
  "6759",
  "6443",
  "6040",
  "6041",
  "6042",
  "6045",
  "6250",
  "6251",
  "6444",
  "6447",
  "6338",
  "6450",
  "6451",
  "6454",
  "6456",
  "6762",
  "6455",
  "6457",
  "6459",
  "6460",
  "6461",
  "6467",
  "6468",
  "6353",
  "6469",
  "6354",
  "6763",
  "6355",
  "6770",
  "6050",
  "6051",
  "6052",
  "6053",
  "6840",
  "6842",
  "6812",
  "6057",
  "6501",
  "6502",
  "6503",
  "6504",
  "6505",
  "6506",
  "6507",
  "6508",
  "6509",
  "6510",
  "6511",
  "6513",
  "6515",
  "6519",
  "6520",
  "6521",
  "6530",
  "6531",
  "6532",
  "6533",
  "6534",
  "6535",
  "6536",
  "6537",
  "6538",
  "6540",
  "6320",
  "6776",
  "6777",
  "6111",
  "6131",
  "6470",
  "6357",
  "6058",
  "6471",
  "6059",
  "6254",
  "6060",
  "6255",
  "6473",
  "6359",
  "6474",
  "6256",
  "6778",
  "6472",
  "6850",
  "6851",
  "6852",
  "6853",
  "6854",
  "6855",
  "6856",
  "6857",
  "6858",
  "6859",
  "6860",
  "6360",
  "6370",
  "6779",
  "6870",
  "6371",
  "6372",
  "6475",
  "6373",
  "6477",
  "6478",
  "6379",
  "6781",
  "6061",
  "6374",
  "6062",
  "6479",
  "6782",
  "6258",
  "6259",
  "6064",
  "6480",
  "6365",
  "6712",
  "6260",
  "6375",
  "6262",
  "6896",
  "6875",
  "6876",
  "6877",
  "6879",
  "6878",
  "6065",
  "6481",
  "6067",
  "6263",
  "6783",
  "6420",
  "6068",
  "6482",
  "6264",
  "6483",
  "6069",
  "6484",
  "6784",
  "6070",
  "6071",
  "6072",
  "6487",
  "6073",
  "6785",
  "6376",
  "6265",
  "6266",
  "6074",
  "6267",
  "6488",
  "6489",
  "6890",
  "6075",
  "6076",
  "6077",
  "6901",
  "6902",
  "6903",
  "6904",
  "6905",
  "6906",
  "6907",
  "6910",
  "6911",
  "6912",
  "6913",
  "6914",
  "6920",
  "6921",
  "6922",
  "6925",
  "6926",
  "6927",
  "6928",
  "6377",
  "6491",
  "6378",
  "6268",
  "6269",
  "6497",
  "6614",
  "6615",
  "6078",
  "6080",
  "6079",
  "6380",
  "6081",
  "6786",
  "6787",
  "6277",
  "6084",
  "6790",
  "6792",
  "6611",
  "6382",
  "6085",
  "6087",
  "6066",
  "6383",
  "6384",
  "6492",
  "6493",
  "6494",
  "6495",
  "6793",
  "6794",
  "6701",
  "6702",
  "6703",
  "6704",
  "6705",
  "6706",
  "6708",
  "6710",
  "6720",
  "6721",
  "6722",
  "6723",
  "6724",
  "6725",
  "6726",
  "6749",
  "6385",
  "6386",
  "6795",
  "6387",
  "6089",
  "6796",
  "6090",
  "6107",
  "6110",
  "6117",
  "6119",
  "6127",
  "6133",
  "6137",
  "6091",
  "6516",
  "6388",
  "6092",
  "6093",
  "6498",
  "6883",
  "6880",
  "6881",
  "6888",
  "6889",
  "6109",
  "6129",
  "6226",
  "6279",
  "6897",
  "6094",
  "6280",
  "6006",
  "6095",
  "6096",
  "6098",
  "6716",
  "6525",
  "6798",
  "6281",
  "6282",
  "6389",
  "4406",
  "4001",
  "4606",
  "4910",
  "4002",
  "4535",
  "4216",
  "4911",
  "4732",
  "4912",
  "4210",
  "4211",
  "4212",
  "4330",
  "4332",
  "4333",
  "4336",
  "4338",
  "4408",
  "4003",
  "4694",
  "4401",
  "4402",
  "4609",
  "4004",
  "4653",
  "4530",
  "4611",
  "4915",
  "4917",
  "4918",
  "4733",
  "4612",
  "3901",
  "4217",
  "4005",
  "4007",
  "4006",
  "4920",
  "4613",
  "4734",
  "4614",
  "4537",
  "4538",
  "4287",
  "4008",
  "4410",
  "4411",
  "4551",
  "4412",
  "4735",
  "4009",
  "4539",
  "4616",
  "4921",
  "4617",
  "4413",
  "4010",
  "4414",
  "4415",
  "4011",
  "4219",
  "4220",
  "4416",
  "4417",
  "4922",
  "4013",
  "4093",
  "4619",
  "4923",
  "4843",
  "4924",
  "4221",
  "4107",
  "3902",
  "4014",
  "4925",
  "4736",
  "4419",
  "4015",
  "4420",
  "4421",
  "4016",
  "4541",
  "4422",
  "4017",
  "4622",
  "4926",
  "4737",
  "4019",
  "4927",
  "4623",
  "4341",
  "4624",
  "4928",
  "4427",
  "4020",
  "4625",
  "4738",
  "4021",
  "4110",
  "4563",
  "4626",
  "4543",
  "4424",
  "4223",
  "4627",
  "4022",
  "4628",
  "4929",
  "4930",
  "4224",
  "4932",
  "4426",
  "4342",
  "4225",
  "4222",
  "4739",
  "4226",
  "4024",
  "4629",
  "4544",
  "4227",
  "4228",
  "4630",
  "4430",
  "4933",
  "4431",
  "4028",
  "4230",
  "4935",
  "4030",
  "4234",
  "4343",
  "4740",
  "4631",
  "4428",
  "4556",
  "3903",
  "4605",
  "4741",
  "4434",
  "4936",
  "4435",
  "4937",
  "4105",
  "4344",
  "4938",
  "4940",
  "4742",
  "4743",
  "4744",
  "4438",
  "4634",
  "4941",
  "4032",
  "4033",
  "4034",
  "4635",
  "4745",
  "4547",
  "4037",
  "4345",
  "4939",
  "4548",
  "4846",
  "4038",
  "4607",
  "4746",
  "4637",
  "4039",
  "4418",
  "4236",
  "4441",
  "4442",
  "4255",
  "4443",
  "4347",
  "4444",
  "4640",
  "4237",
  "4642",
  "4942",
  "4079",
  "4643",
  "4040",
  "4943",
  "4238",
  "4944",
  "4041",
  "4429",
  "4042",
  "4847",
  "4730",
  "4448",
  "4449",
  "4644",
  "4747",
  "4645",
  "4549",
  "4848",
  "4646",
  "4945",
  "4239",
  "4348",
  "4648",
  "4649",
  "4450",
  "4043",
  "4046",
  "4349",
  "4947",
  "4451",
  "3904",
  "3905",
  "4453",
  "4454",
  "4027",
  "4455",
  "4263",
  "4456",
  "4240",
  "4241",
  "4243",
  "4949",
  "4048",
  "4750",
  "4751",
  "4049",
  "4457",
  "4849",
  "4850",
  "4250",
  "4252",
  "4350",
  "4650",
  "4253",
  "4254",
  "4050",
  "4051",
  "4652",
  "4654",
  "4655",
  "4756",
  "4950",
  "4351",
  "4757",
  "4758",
  "4851",
  "4459",
  "4256",
  "4657",
  "4460",
  "4257",
  "4658",
  "4461",
  "4462",
  "4463",
  "4258",
  "4852",
  "4259",
  "4951",
  "4464",
  "4760",
  "4054",
  "4952",
  "4660",
  "4352",
  "4055",
  "4260",
  "4554",
  "4761",
  "4954",
  "4961",
  "4955",
  "4762",
  "4956",
  "4553",
  "4056",
  "4953",
  "4261",
  "4555",
  "4957",
  "4958",
  "3906",
  "4057",
  "4853",
  "4262",
  "4265",
  "4266",
  "4962",
  "4061",
  "4267",
  "4097",
  "4662",
  "4268",
  "4763",
  "4963",
  "4063",
  "3907",
  "4467",
  "4064",
  "4468",
  "4964",
  "4471",
  "4472",
  "4469",
  "4473",
  "4474",
  "4066",
  "4854",
  "4764",
  "4270",
  "4354",
  "4965",
  "4271",
  "4047",
  "4475",
  "4765",
  "4108",
  "4558",
  "4666",
  "4476",
  "4766",
  "4667",
  "4290",
  "4966",
  "4562",
  "4967",
  "4969",
  "4274",
  "4855",
  "4768",
  "4068",
  "4101",
  "4102",
  "4103",
  "4104",
  "4109",
  "4112",
  "4122",
  "4123",
  "4124",
  "4069",
  "4769",
  "4668",
  "4669",
  "4346",
  "4970",
  "4071",
  "4355",
  "4357",
  "4671",
  "4841",
  "4856",
  "4478",
  "4564",
  "4275",
  "4276",
  "4280",
  "4072",
  "4772",
  "4971",
  "4773",
  "4774",
  "4672",
  "4972",
  "4073",
  "4479",
  "4673",
  "4070",
  "4074",
  "4674",
  "4675",
  "4973",
  "4974",
  "4029",
  "4075",
  "4565",
  "4481",
  "4676",
  "4076",
  "4975",
  "4775",
  "4776",
  "4485",
  "4779",
  "4976",
  "4978",
  "4780",
  "4979",
  "4677",
  "3908",
  "4568",
  "4077",
  "4358",
  "4078",
  "4359",
  "4281",
  "4106",
  "4116",
  "4858",
  "4082",
  "4576",
  "4679",
  "4487",
  "4083",
  "4859",
  "4570",
  "4777",
  "4084",
  "4085",
  "4488",
  "4680",
  "4489",
  "4783",
  "4981",
  "4231",
  "4681",
  "4982",
  "4983",
  "4664",
  "4292",
  "4683",
  "4684",
  "4685",
  "4984",
  "4860",
  "4861",
  "4986",
  "4490",
  "4086",
  "4571",
  "4987",
  "4282",
  "4862",
  "4988",
  "4785",
  "4491",
  "4989",
  "4360",
  "4863",
  "4492",
  "4572",
  "4781",
  "4573",
  "4864",
  "4786",
  "4574",
  "4087",
  "4088",
  "4901",
  "4903",
  "4284",
  "4285",
  "4090",
  "4686",
  "4091",
  "4286",
  "4575",
  "4493",
  "4992",
  "4985",
  "4094",
  "4288",
  "4095",
  "4289",
  "4291",
  "4865",
  "4092",
  "4098",
  "4787",
  "4353",
  "4691",
  "4294",
  "4062",
  "4363",
  "4495",
  "4693",
  "4496",
  "4364",
  "4578",
  "4579",
  "4497",
  "4096",
  "3909",
  "3910",
  "3911",
  "2351",
  "2018",
  "1718",
  "1720",
  "2743",
  "1220",
  "1001",
  "2134",
  "1913",
  "1002",
  "1003",
  "1004",
  "1810",
  "1812",
  "1899",
  "5501",
  "5544",
  "2474",
  "2476",
  "2475",
  "1430",
  "1431",
  "1330",
  "1721",
  "1222",
  "2702",
  "1331",
  "2703",
  "2763",
  "1501",
  "2466",
  "2322",
  "1432",
  "2457",
  "1436",
  "2630",
  "1005",
  "1223",
  "1730",
  "1007",
  "2019",
  "2478",
  "2779",
  "1224",
  "1503",
  "1337",
  "1915",
  "1821",
  "1822",
  "1504",
  "1008",
  "1740",
  "1009",
  "2108",
  "2109",
  "2110",
  "2111",
  "2112",
  "2113",
  "2114",
  "2115",
  "2116",
  "2117",
  "2118",
  "2123",
  "2133",
  "2163",
  "2196",
  "2199",
  "2201",
  "2203",
  "2204",
  "2205",
  "2206",
  "2207",
  "2210",
  "2211",
  "2212",
  "2215",
  "2216",
  "2217",
  "2222",
  "2241",
  "2266",
  "2283",
  "2284",
  "2293",
  "2295",
  "2297",
  "2298",
  "1719",
  "1921",
  "1505",
  "2184",
  "2185",
  "2020",
  "2631",
  "2324",
  "2325",
  "2135",
  "1010",
  "2301",
  "2302",
  "2303",
  "2304",
  "2305",
  "1506",
  "2445",
  "2446",
  "2447",
  "2327",
  "1338",
  "1803",
  "1805",
  "2532",
  "2542",
  "1922",
  "2138",
  "2139",
  "2140",
  "2141",
  "2142",
  "2238",
  "2239",
  "2021",
  "1741",
  "2330",
  "2534",
  "2632",
  "2634",
  "2636",
  "1339",
  "2129",
  "1507",
  "1508",
  "1509",
  "2712",
  "2633",
  "1824",
  "2150",
  "1611",
  "1225",
  "1011",
  "1012",
  "2467",
  "1013",
  "1014",
  "1020",
  "1021",
  "1022",
  "2535",
  "1510",
  "2025",
  "1340",
  "1742",
  "1341",
  "2635",
  "2637",
  "1026",
  "2713",
  "1226",
  "1227",
  "1923",
  "2714",
  "2026",
  "2027",
  "1342",
  "2638",
  "2639",
  "1434",
  "2715",
  "2121",
  "2122",
  "2125",
  "2124",
  "1516",
  "2030",
  "1826",
  "1343",
  "1571",
  "1827",
  "2331",
  "2332",
  "2128",
  "2228",
  "2333",
  "1515",
  "2641",
  "2536",
  "2717",
  "1028",
  "2031",
  "2643",
  "1029",
  "1517",
  "2537",
  "2718",
  "1438",
  "2032",
  "2538",
  "2189",
  "2642",
  "1027",
  "2334",
  "2539",
  "2337",
  "1344",
  "1929",
  "2149",
  "2719",
  "2720",
  "2721",
  "2722",
  "2723",
  "2724",
  "2540",
  "2541",
  "1745",
  "1030",
  "1518",
  "1420",
  "1062",
  "2644",
  "2035",
  "1701",
  "1702",
  "1703",
  "1704",
  "1705",
  "2038",
  "1440",
  "1833",
  "1031",
  "1354",
  "1229",
  "1930",
  "1931",
  "1032",
  "1519",
  "1033",
  "1034",
  "1230",
  "2041",
  "2040",
  "1301",
  "1302",
  "1450",
  "1470",
  "1471",
  "1834",
  "1035",
  "2338",
  "1936",
  "1036",
  "2339",
  "2340",
  "1731",
  "2341",
  "1037",
  "1451",
  "2645",
  "2646",
  "1038",
  "1937",
  "1830",
  "1831",
  "1832",
  "1835",
  "1039",
  "1346",
  "2043",
  "2044",
  "1235",
  "2343",
  "1520",
  "1521",
  "1746",
  "1040",
  "1041",
  "1747",
  "1748",
  "1236",
  "1452",
  "1749",
  "2045",
  "2047",
  "1050",
  "2601",
  "2647",
  "2136",
  "1151",
  "1938",
  "2130",
  "1522",
  "2364",
  "1347",
  "2347",
  "2348",
  "1523",
  "1237",
  "1840",
  "1841",
  "1842",
  "1843",
  "1238",
  "1053",
  "1524",
  "1240",
  "1242",
  "1453",
  "1054",
  "2420",
  "2421",
  "1773",
  "1525",
  "1460",
  "1106",
  "1116",
  "1850",
  "1851",
  "1852",
  "1853",
  "1854",
  "1056",
  "1462",
  "1901",
  "1902",
  "1903",
  "1904",
  "1905",
  "1910",
  "1940",
  "2148",
  "1526",
  "1944",
  "2345",
  "2048",
  "1945",
  "2738",
  "1752",
  "2050",
  "2051",
  "2648",
  "2649",
  "2126",
  "2739",
  "1754",
  "2052",
  "2153",
  "2155",
  "2053",
  "2176",
  "1756",
  "2552",
  "1860",
  "1844",
  "2344",
  "2346",
  "2349",
  "1243",
  "1949",
  "1757",
  "1244",
  "1527",
  "1349",
  "2054",
  "1529",
  "2186",
  "2187",
  "2055",
  "2350",
  "1350",
  "1057",
  "1351",
  "1245",
  "2553",
  "1908",
  "2554",
  "2584",
  "1760",
  "2492",
  "2494",
  "2740",
  "2741",
  "2742",
  "2744",
  "2745",
  "2746",
  "1531",
  "1355",
  "2456",
  "1951",
  "1950",
  "2458",
  "2459",
  "2461",
  "2462",
  "2464",
  "2460",
  "2495",
  "2056",
  "1247",
  "1059",
  "1845",
  "2760",
  "2761",
  "1862",
  "1535",
  "2355",
  "2650",
  "1863",
  "2747",
  "2764",
  "2651",
  "2356",
  "2357",
  "1252",
  "2556",
  "1536",
  "1066",
  "2059",
  "1537",
  "2358",
  "1864",
  "1889",
  "2060",
  "2652",
  "1538",
  "2455",
  "2191",
  "1060",
  "1061",
  "1063",
  "1532",
  "1534",
  "1360",
  "2766",
  "2061",
  "2062",
  "1865",
  "2557",
  "1068",
  "2065",
  "2558",
  "1364",
  "2653",
  "2655",
  "1253",
  "1540",
  "1069",
  "1612",
  "1960",
  "1961",
  "2359",
  "1463",
  "1366",
  "1866",
  "1201",
  "1202",
  "1203",
  "1070",
  "2762",
  "2360",
  "2361",
  "2362",
  "2367",
  "2559",
  "1965",
  "1541",
  "2657",
  "2169",
  "2170",
  "2171",
  "2269",
  "2368",
  "2767",
  "2768",
  "1867",
  "2137",
  "2769",
  "2151",
  "1254",
  "1542",
  "2770",
  "2370",
  "1966",
  "2131",
  "1367",
  "1969",
  "2119",
  "2120",
  "1368",
  "1071",
  "1543",
  "2561",
  "2562",
  "1970",
  "1971",
  "1952",
  "1255",
  "2563",
  "1906",
  "1256",
  "2066",
  "2771",
  "2067",
  "1257",
  "1370",
  "2070",
  "1770",
  "1464",
  "1545",
  "1546",
  "1072",
  "2564",
  "2565",
  "2725",
  "2726",
  "2143",
  "2144",
  "2145",
  "1074",
  "2127",
  "2366",
  "2659",
  "2748",
  "1373",
  "2660",
  "2375",
  "1258",
  "1560",
  "1075",
  "1982",
  "2661",
  "1561",
  "1260",
  "2662",
  "2071",
  "2663",
  "2190",
  "2664",
  "1073",
  "1772",
  "1550",
  "1259",
  "1077",
  "1562",
  "1101",
  "1102",
  "1103",
  "1104",
  "1105",
  "1107",
  "1108",
  "1109",
  "1111",
  "1115",
  "1118",
  "1119",
  "1128",
  "1129",
  "1133",
  "1138",
  "1139",
  "1144",
  "1152",
  "1195",
  "1199",
  "1564",
  "1467",
  "1262",
  "1263",
  "2180",
  "2072",
  "1775",
  "1566",
  "1776",
  "1375",
  "1590",
  "1907",
  "2777",
  "2780",
  "2783",
  "1468",
  "1876",
  "1079",
  "1080",
  "1983",
  "1469",
  "2666",
  "1376",
  "1879",
  "1264",
  "1568",
  "1569",
  "2568",
  "2468",
  "1880",
  "1081",
  "2081",
  "2451",
  "2452",
  "2453",
  "2454",
  "1082",
  "2571",
  "1083",
  "1378",
  "2471",
  "2472",
  "2477",
  "2479",
  "1778",
  "1570",
  "2482",
  "2481",
  "2667",
  "1379",
  "1380",
  "1984",
  "2668",
  "1885",
  "1583",
  "2379",
  "1585",
  "2669",
  "1084",
  "2573",
  "2670",
  "2574",
  "1472",
  "2671",
  "1088",
  "2672",
  "2156",
  "1586",
  "1985",
  "2465",
  "2132",
  "1089",
  "1090",
  "1266",
  "2575",
  "1474",
  "2576",
  "1092",
  "2673",
  "1580",
  "1581",
  "1582",
  "1085",
  "1086",
  "1886",
  "1441",
  "1473",
  "2493",
  "2790",
  "2791",
  "2090",
  "2188",
  "1093",
  "1094",
  "2381",
  "1588",
  "2382",
  "1095",
  "1096",
  "1267",
  "1887",
  "1475",
  "1477",
  "1890",
  "1270",
  "2152",
  "1801",
  "1806",
  "1807",
  "1808",
  "1813",
  "1815",
  "1888",
  "2543",
  "1784",
  "1601",
  "1602",
  "1603",
  "1604",
  "1605",
  "1606",
  "1607",
  "1608",
  "1609",
  "1610",
  "1613",
  "1614",
  "1615",
  "1653",
  "1654",
  "1655",
  "1097",
  "1098",
  "2093",
  "2675",
  "3601",
  "3602",
  "3809",
  "3810",
  "3031",
  "3216",
  "3440",
  "3217",
  "3441",
  "3811",
  "3032",
  "3218",
  "3825",
  "3812",
  "3740",
  "3110",
  "3220",
  "3442",
  "3570",
  "3574",
  "3304",
  "3221",
  "3575",
  "3222",
  "3033",
  "3223",
  "3741",
  "3034",
  "3224",
  "3225",
  "3813",
  "3226",
  "3814",
  "3227",
  "3815",
  "3816",
  "3603",
  "3036",
  "3443",
  "3258",
  "3817",
  "3743",
  "3576",
  "3301",
  "3302",
  "3303",
  "3305",
  "3229",
  "3818",
  "3745",
  "3746",
  "3230",
  "3819",
  "3037",
  "3038",
  "3820",
  "3821",
  "3822",
  "3604",
  "3444",
  "3046",
  "3824",
  "3231",
  "3040",
  "3041",
  "3826",
  "3827",
  "3830",
  "3832",
  "3882",
  "3233",
  "3748",
  "3749",
  "3042",
  "3234",
  "3579",
  "3750",
  "3833",
  "3835",
  "3447",
  "3043",
  "3580",
  "3235",
  "3836",
  "3044",
  "3751",
  "3249",
  "3237",
  "3837",
  "3448",
  "3838",
  "3238",
  "3045",
  "3581",
  "3752",
  "3240",
  "3753",
  "3047",
  "3840",
  "3048",
  "3582",
  "3754",
  "3841",
  "3842",
  "3843",
  "3844",
  "3449",
  "3755",
  "3450",
  "3765",
  "3241",
  "3242",
  "3243",
  "3244",
  "3451",
  "3245",
  "3049",
  "3106",
  "3051",
  "3845",
  "3846",
  "3452",
  "3583",
  "3847",
  "3431",
  "3435",
  "3848",
  "3246",
  "3247",
  "3584",
  "3756",
  "3766",
  "3861",
  "3605",
  "3251",
  "3585",
  "3052",
  "3561",
  "3252",
  "3053",
  "3307",
  "3768",
  "3769",
  "3082",
  "3823",
  "3849",
  "3101",
  "3102",
  "3103",
  "3104",
  "3105",
  "3107",
  "3108",
  "3109",
  "3111",
  "3455",
  "3456",
  "3850",
  "3253",
  "3770",
  "3054",
  "3588",
  "3055",
  "3851",
  "3852",
  "3853",
  "3771",
  "3057",
  "3254",
  "3589",
  "3060",
  "3061",
  "3062",
  "3063",
  "3064",
  "3457",
  "3070",
  "3854",
  "3855",
  "3256",
  "3071",
  "3257",
  "3255",
  "3856",
  "3805",
  "3857",
  "3773",
  "3858",
  "3859",
  "3860",
  "3862",
  "3774",
  "3073",
  "3259",
  "3590",
  "3260",
  "3609",
  "3262",
  "3261",
  "3290",
  "3777",
  "3864",
  "3076",
  "3458",
  "3779",
  "3780",
  "3592",
  "3263",
  "3781",
  "3865",
  "3264",
  "3801",
  "3802",
  "3803",
  "3804",
  "3593",
  "3077",
  "3461",
  "3839",
  "3866",
  "3867",
  "3868",
  "3869",
  "3266",
  "3870",
  "3871",
  "3079",
  "3268",
  "3269",
  "3872",
  "3873",
  "3874",
  "3875",
  "3878",
  "3607",
  "3272",
  "3273",
  "3883",
  "3462",
  "3284",
  "3274",
  "3464",
  "3884",
  "3885",
  "3586",
  "3445",
  "3782",
  "3275",
  "3446",
  "3886",
  "3084",
  "3285",
  "3276",
  "3298",
  "3299",
  "3465",
  "3595",
  "3887",
  "3608",
  "3278",
  "3279",
  "3280",
  "3215",
  "3281",
  "3282",
  "3466",
  "3784",
  "3291",
  "3890",
  "3468",
  "3597",
  "3469",
  "3467",
  "3598",
  "3287",
  "3086",
  "3470",
  "3087",
  "3289",
  "3894",
  "3896",
  "3897",
  "3293",
  "3785",
  "8201",
  "8205",
  "7710",
  "7820",
  "7401",
  "7711",
  "8501",
  "8720",
  "8001",
  "7620",
  "7821",
  "8801",
  "8802",
  "7712",
  "8004",
  "8401",
  "8404",
  "8405",
  "7716",
  "8106",
  "7822",
  "8202",
  "7001",
  "7717",
  "8803",
  "8005",
  "8006",
  "8007",
  "7920",
  "7002",
  "8721",
  "8008",
  "8722",
  "7921",
  "7718",
  "8502",
  "7109",
  "8031",
  "8099",
  "7715",
  "7719",
  "7823",
  "7621",
  "7922",
  "8009",
  "7924",
  "8010",
  "8011",
  "8012",
  "7825",
  "8504",
  "7003",
  "7403",
  "8804",
  "7603",
  "7005",
  "8505",
  "8805",
  "7720",
  "7826",
  "7890",
  "8723",
  "8724",
  "8014",
  "8302",
  "8807",
  "8730",
  "8203",
  "8808",
  "7926",
  "8015",
  "7828",
  "8310",
  "8016",
  "7405",
  "7829",
  "7006",
  "7007",
  "7830",
  "8101",
  "8102",
  "8103",
  "8104",
  "8105",
  "8204",
  "8210",
  "8212",
  "7072",
  "7008",
  "8018",
  "7009",
  "7927",
  "8311",
  "7831",
  "7928",
  "8019",
  "8002",
  "8003",
  "8034",
  "7930",
  "8515",
  "7066",
  "8020",
  "8312",
  "8021",
  "7010",
  "7721",
  "7011",
  "7012",
  "7013",
  "7014",
  "7015",
  "8809",
  "7624",
  "8108",
  "8213",
  "7067",
  "7722",
  "7832",
  "8022",
  "7961",
  "8511",
  "8512",
  "7016",
  "8514",
  "7626",
  "8810",
  "7723",
  "8023",
  "8313",
  "7833",
  "8314",
  "7627",
  "8214",
  "7834",
  "8315",
  "8316",
  "8317",
  "7801",
  "7802",
  "7628",
  "8812",
  "8816",
  "7936",
  "7017",
  "7018",
  "7019",
  "7073",
  "7724",
  "7799",
  "7020",
  "8817",
  "8818",
  "8820",
  "8837",
  "8899",
  "8215",
  "8234",
  "7201",
  "7202",
  "7207",
  "7208",
  "7206",
  "8318",
  "7407",
  "8217",
  "7630",
  "7631",
  "7632",
  "7726",
  "7021",
  "8319",
  "8025",
  "7704",
  "7410",
  "7004",
  "8320",
  "7022",
  "7023",
  "7931",
  "7727",
  "8821",
  "7836",
  "8822",
  "8518",
  "7932",
  "8863",
  "8731",
  "7024",
  "7703",
  "8321",
  "7416",
  "7417",
  "8823",
  "8322",
  "7728",
  "8825",
  "7026",
  "7027",
  "8026",
  "8027",
  "7933",
  "7934",
  "8028",
  "7837",
  "8826",
  "7028",
  "7452",
  "8029",
  "7418",
  "8030",
  "8218",
  "7838",
  "8219",
  "7935",
  "7839",
  "8323",
  "8032",
  "7601",
  "7602",
  "7840",
  "8035",
  "8033",
  "8036",
  "7508",
  "7538",
  "7419",
  "8037",
  "8827",
  "8038",
  "7640",
  "7029",
  "8039",
  "7604",
  "7420",
  "7641",
  "7506",
  "7507",
  "7730",
  "8324",
  "8828",
  "7421",
  "7842",
  "8829",
  "7422",
  "8904",
  "7732",
  "8520",
  "8844",
  "7642",
  "7205",
  "7423",
  "7030",
  "7733",
  "7843",
  "7844",
  "8525",
  "7731",
  "8526",
  "7845",
  "7111",
  "8830",
  "8732",
  "8527",
  "7097",
  "7302",
  "7303",
  "7304",
  "7305",
  "7306",
  "7307",
  "7308",
  "7309",
  "7310",
  "7311",
  "7395",
  "7399",
  "8041",
  "7846",
  "8640",
  "8641",
  "8042",
  "7734",
  "7032",
  "7099",
  "8832",
  "8824",
  "7033",
  "7847",
  "7735",
  "8528",
  "7848",
  "7034",
  "7849",
  "8733",
  "8701",
  "8530",
  "7850",
  "8326",
  "8734",
  "8735",
  "8045",
  "8648",
  "7851",
  "8833",
  "7852",
  "8220",
  "8327",
  "7737",
  "7605",
  "7938",
  "7035",
  "7738",
  "7036",
  "8221",
  "7424",
  "7643",
  "7739",
  "8834",
  "7039",
  "7644",
  "7740",
  "7853",
  "8403",
  "8048",
  "7071",
  "7939",
  "7940",
  "8049",
  "7430",
  "7495",
  "8328",
  "8050",
  "8736",
  "8759",
  "8738",
  "8051",
  "8835",
  "8052",
  "7040",
  "8402",
  "7746",
  "8053",
  "8223",
  "8836",
  "7747",
  "8329",
  "8330",
  "7607",
  "7428",
  "8055",
  "7945",
  "8109",
  "8840",
  "8056",
  "8846",
  "7748",
  "7855",
  "7432",
  "8848",
  "7041",
  "7946",
  "8510",
  "8535",
  "8850",
  "8332",
  "8340",
  "7803",
  "8341",
  "8342",
  "7750",
  "8852",
  "8831",
  "8343",
  "7827",
  "7042",
  "7043",
  "7645",
  "7045",
  "7074",
  "8057",
  "7751",
  "7950",
  "7960",
  "7962",
  "7963",
  "7856",
  "8059",
  "7970",
  "8060",
  "8054",
  "8061",
  "7878",
  "7046",
  "7092",
  "8062",
  "8063",
  "7752",
  "7753",
  "7754",
  "8853",
  "7857",
  "8901",
  "8903",
  "8905",
  "8906",
  "8922",
  "8933",
  "8988",
  "8989",
  "8533",
  "8224",
  "8064",
  "7646",
  "7974",
  "7976",
  "7101",
  "7102",
  "7103",
  "7104",
  "7105",
  "7106",
  "7107",
  "7108",
  "7112",
  "7114",
  "7175",
  "7182",
  "7184",
  "7188",
  "7189",
  "7191",
  "7192",
  "7193",
  "7194",
  "7195",
  "7198",
  "7199",
  "8344",
  "7435",
  "8345",
  "7860",
  "8346",
  "8347",
  "8739",
  "7031",
  "7047",
  "8902",
  "8225",
  "7647",
  "7648",
  "7110",
  "7438",
  "7755",
  "7436",
  "8107",
  "8226",
  "8740",
  "7756",
  "8230",
  "7757",
  "8231",
  "7439",
  "8857",
  "8858",
  "7649",
  "7050",
  "7051",
  "7863",
  "7650",
  "8065",
  "7652",
  "7653",
  "7656",
  "8859",
  "7054",
  "7055",
  "7501",
  "7502",
  "7503",
  "7504",
  "7505",
  "7509",
  "7510",
  "7513",
  "7514",
  "7522",
  "7524",
  "7533",
  "7543",
  "7544",
  "8066",
  "7977",
  "8067",
  "8068",
  "8534",
  "8069",
  "8110",
  "8070",
  "7440",
  "8861",
  "8862",
  "8865",
  "7806",
  "8741",
  "7058",
  "8854",
  "8855",
  "8071",
  "8867",
  "7060",
  "7061",
  "7062",
  "7063",
  "8536",
  "8232",
  "7978",
  "8742",
  "8240",
  "7442",
  "7444",
  "8348",
  "7758",
  "7865",
  "8349",
  "7064",
  "8241",
  "7979",
  "8540",
  "8541",
  "8542",
  "8543",
  "8544",
  "8550",
  "8868",
  "8072",
  "7065",
  "7446",
  "8073",
  "7869",
  "8869",
  "8870",
  "7701",
  "7709",
  "8350",
  "8074",
  "7657",
  "7660",
  "7450",
  "7451",
  "8551",
  "7456",
  "8242",
  "7661",
  "7457",
  "8075",
  "8076",
  "8077",
  "8691",
  "7662",
  "7866",
  "8553",
  "8554",
  "8555",
  "7068",
  "7203",
  "7204",
  "8556",
  "8352",
  "7760",
  "8078",
  "7070",
  "7663",
  "7458",
  "8079",
  "8871",
  "8872",
  "7870",
  "7076",
  "8750",
  "8243",
  "8751",
  "8752",
  "7094",
  "7096",
  "8557",
  "7077",
  "8080",
  "8353",
  "7078",
  "7702",
  "8081",
  "8558",
  "8083",
  "8244",
  "8873",
  "8875",
  "8876",
  "8879",
  "8880",
  "8245",
  "7606",
  "7079",
  "7080",
  "8882",
  "8246",
  "7871",
  "8884",
  "7762",
  "7081",
  "7874",
  "8885",
  "8886",
  "7875",
  "7980",
  "7460",
  "8559",
  "8247",
  "8084",
  "8248",
  "7876",
  "7901",
  "7902",
  "7461",
  "7877",
  "8085",
  "7666",
  "7670",
  "7763",
  "7608",
  "7699",
  "8086",
  "8887",
  "8560",
  "8753",
  "8754",
  "8755",
  "8756",
  "8757",
  "7511",
  "7512",
  "7082",
  "7676",
  "7879",
  "8601",
  "8602",
  "8603",
  "8604",
  "8605",
  "8606",
  "8607",
  "8608",
  "8609",
  "8610",
  "8611",
  "8618",
  "8619",
  "8620",
  "8625",
  "8628",
  "8629",
  "8638",
  "8644",
  "8645",
  "8646",
  "8647",
  "8650",
  "8666",
  "8690",
  "8695",
  "8250",
  "8087",
  "7083",
  "7087",
  "7088",
  "8406",
  "7462",
  "7044",
  "7880",
  "8251",
  "8088",
  "8360",
  "8361",
  "8362",
  "8043",
  "7463",
  "7057",
  "7881",
  "7465",
  "8758",
  "7059",
  "7882",
  "7069",
  "8089",
  "7470",
  "7474",
  "7477",
  "7086",
  "8090",
  "8091",
  "8092",
  "7764",
  "7480",
  "7093",
  "7052",
  "7090",
  "7091",
  "8093",
  "7675",
  "7885",
  "7981",
  "7983",
  "7999",
  "8888",
  "8889",
  "8252",
  "7765",
  "8260",
  "8094",
  "8046",
  "8561",
  "8095",
  "7075",
  "8270",
  "7095",
  "8096",
  "8097",
  "7677",
  "8098",
  "8562",
  "7481",
  "8890",
  "6390",
  "2801",
  "2802",
  "2804",
  "2806",
  "2807",
  "2808",
  "2809",
  "2812",
  "2863",
  "2813",
  "2814",
  "2815",
  "2816",
  "2910",
  "2920",
  "2921",
  "2864",
  "2818",
  "2914",
  "2822",
  "2823",
  "2824",
  "2825",
  "2826",
  "2827",
  "2828",
  "2829",
  "2830",
  "2831",
  "2832",
  "2833",
  "2835",
  "2919",
  "2836",
  "2881",
  "2865",
  "2837",
  "2838",
  "2839",
  "2842",
  "2882",
  "2840",
  "2841",
  "2852",
  "2854",
  "2911",
  "2857",
  "2896",
  "2858",
  "2859",
  "2860",
  "2861",
  "2862",
  "2883",
  "2871",
  "2901",
  "2902",
  "2903",
  "2904",
  "2905",
  "2906",
  "2907",
  "2908",
  "2909",
  "2912",
  "2918",
  "2940",
  "2872",
  "2915",
  "2873",
  "2916",
  "2874",
  "2875",
  "2876",
  "2877",
  "2917",
  "2878",
  "2879",
  "2880",
  "2885",
  "2886",
  "2887",
  "2888",
  "2889",
  "2817",
  "2892",
  "2893",
  "2891",
  "2894",
  "2895",
  "2898",
  "5640",
  "5820",
  "5440",
  "5250",
  "5030",
  "5901",
  "5441",
  "5031",
  "5821",
  "5641",
  "5822",
  "5875",
  "5823",
  "5902",
  "5101",
  "5730",
  "5442",
  "5201",
  "5731",
  "5032",
  "5732",
  "5340",
  "5033",
  "5733",
  "5301",
  "5302",
  "5303",
  "5304",
  "5034",
  "5035",
  "5734",
  "5443",
  "5036",
  "5037",
  "5401",
  "5402",
  "5405",
  "5406",
  "5408",
  "5647",
  "5648",
  "5444",
  "5141",
  "5903",
  "5735",
  "5142",
  "5736",
  "5445",
  "5038",
  "5143",
  "5144",
  "5737",
  "5439",
  "5446",
  "5449",
  "5824",
  "5039",
  "5825",
  "5826",
  "5827",
  "5738",
  "5739",
  "5828",
  "5829",
  "5830",
  "5251",
  "5252",
  "5649",
  "5447",
  "5832",
  "5650",
  "5833",
  "5040",
  "5253",
  "5341",
  "5448",
  "5836",
  "5837",
  "5740",
  "5651",
  "5741",
  "5041",
  "5042",
  "5838",
  "5043",
  "5742",
  "5652",
  "5653",
  "5450",
  "5451",
  "5452",
  "5453",
  "5479",
  "5743",
  "5454",
  "5455",
  "5045",
  "5456",
  "5744",
  "5745",
  "5457",
  "5746",
  "5904",
  "5839",
  "5146",
  "5840",
  "5458",
  "5654",
  "5747",
  "5841",
  "5842",
  "5046",
  "5905",
  "5748",
  "5843",
  "5047",
  "5048",
  "5049",
  "5459",
  "5460",
  "5461",
  "5462",
  "5655",
  "5750",
  "5845",
  "5846",
  "5463",
  "5342",
  "5343",
  "5464",
  "5465",
  "5656",
  "5466",
  "5751",
  "5657",
  "5148",
  "5847",
  "5848",
  "5149",
  "5906",
  "5849",
  "5850",
  "5851",
  "5254",
  "5255",
  "5344",
  "5658",
  "5050",
  "5753",
  "5757",
  "5468",
  "5469",
  "5470",
  "5471",
  "5601",
  "5602",
  "5603",
  "5604",
  "5609",
  "5620",
  "5633",
  "5660",
  "5853",
  "5661",
  "5662",
  "5758",
  "5472",
  "5051",
  "5345",
  "5855",
  "5857",
  "5257",
  "5759",
  "5858",
  "5473",
  "5052",
  "5474",
  "5665",
  "5666",
  "5053",
  "5260",
  "5150",
  "5054",
  "5859",
  "5663",
  "5664",
  "5907",
  "5055",
  "5860",
  "5760",
  "5861",
  "5761",
  "5862",
  "5151",
  "5152",
  "5762",
  "5763",
  "5667",
  "5056",
  "5058",
  "5764",
  "5261",
  "5765",
  "5153",
  "5346",
  "5059",
  "5060",
  "5061",
  "5062",
  "5350",
  "5476",
  "5671",
  "5676",
  "5001",
  "5009"
];

const checkJobExists = async (zip) => {
  const indices = [
    'jobtrees_postings',
    'indeed_jobs_postings',
    'big_job_site_postings',
    'adzuna_postings',
  ];

  console.log(`ðŸ” Starting job check for zip: ${zip}`);

  const searchRequests = indices.map(async (indexName) => {
    const searchRequestBody = {
      query: {
        bool: {
          must: [
            { term: { 'postcode.keyword': zip } },
          ],
        },
      },
      size: 0,
      track_total_hits: true,
    };

    const searchRequest = {
      host: OPEN_SEARCH_URL,
      path: `/${indexName}/_search`,
      service: 'es',
      region,
      method: 'POST',
      body: JSON.stringify(searchRequestBody),
      headers: { 'Content-Type': 'application/json' },
    };

    aws4.sign(searchRequest, credentials);

    try {
      console.log(`âž¡ï¸ Sending request to index: ${indexName} for zip: ${zip}`);
      const searchResponse = await fetch(`https://${searchRequest.host}${searchRequest.path}`, {
        method: searchRequest.method,
        headers: searchRequest.headers,
        body: searchRequest.body,
      });

      const searchResponseBody = await searchResponse.json();
      const jobCount = searchResponseBody.hits?.total?.value || 0;

      console.log(`âœ… Found ${jobCount} jobs in ${indexName} for zip ${zip}`);
      return jobCount;
    } catch (error) {
      console.error(`âŒ Error checking index "${indexName}" for zip "${zip}":`, error);
      return 0;
    }
  });

  const results = await Promise.all(searchRequests);
  const totalJobs = results.reduce((sum, count) => sum + count, 0);
  console.log(`ðŸ“¦ Total jobs for zip ${zip}: ${totalJobs}`);
  return totalJobs;
};

const checkJobExistsThrottled = async (zip) => {
  return limit(() => checkJobExists(zip));
};

const generateSitemapXml = async () => {
  const outputLines = [];

  console.log('ðŸš€ Starting sitemap/job count generation...');

  for (const zip of removedZipCodes) {
    const totalJobs = await checkJobExistsThrottled(zip);
    outputLines.push(`${zip} - ${totalJobs}`);
  }

  const filePath = path.join(process.cwd(), 'job_counts.txt');
  await fs.writeFile(filePath, outputLines.join('\n'), 'utf-8');
  console.log(`âœ… Job counts written to ${filePath}`);
};

(async () => {
  await generateSitemapXml();
})();